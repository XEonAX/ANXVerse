This port is based on miui_ALIOTHGlobal_V12.5.3.0.RKHMIXM_b628b9f893_11.0

We have extracted the rom with payload-dumper-go.exe taken from https://github.com/ssut/payload-dumper-go
Then we have used 7z to extract the system and vendor image files

We will now start the process of decompiling MiuiCamera

First we need to provide frameworks files for APKTool

cp C:\Projects\roms\alioth\system\system\framework\framework-res.apk .\originals\MiuiFrameworks\framework-res.apk
cp C:\Projects\roms\alioth\system\system\app\miui\miui.apk .\originals\MiuiFrameworks\miui.apk
cp C:\Projects\roms\alioth\system\system\framework\framework-ext-res\framework-ext-res.apk .\originals\MiuiFrameworks\framework-ext-res.apk
cp C:\Projects\roms\alioth\system\system\app\miuisystem\miuisystem.apk .\originals\MiuiFrameworks\miuisystem.apk

Lets Import the FWs into APKTool

java  -jar "..\ANXVerseTools\apktool-cli-all.jar" if -p ..\ANXVerseTools\MiuiFrameworks .\originals\MiuiFrameworks\framework-res.apk
java  -jar "..\ANXVerseTools\apktool-cli-all.jar" if -p ..\ANXVerseTools\MiuiFrameworks .\originals\MiuiFrameworks\miui.apk
java  -jar "..\ANXVerseTools\apktool-cli-all.jar" if -p ..\ANXVerseTools\MiuiFrameworks .\originals\MiuiFrameworks\framework-ext-res.apk
java  -jar "..\ANXVerseTools\apktool-cli-all.jar" if -p ..\ANXVerseTools\MiuiFrameworks .\originals\MiuiFrameworks\miuisystem.apk

We have finished importing the frameworks into APKTool

Lets decompile MiuiCamera
java  -jar "..\ANXVerseTools\apktool-cli-all.jar" d -p ..\ANXVerseTools\MiuiFrameworks -f -b -o .\src\ANXCamera12\src .\originals\MiuiCamera.apk

OhMyGod, Alioth MiuiCamera 13 dex files, Star had 3 originally
We used Android Studio's APK Analyzer to analyze the original APK. It seems Classes7.dex which contains the camera core code is filled upto the brim.
We might need to move some code to classes14 (this will create a new dex file). this will cause problems during modding 
Currently the referenced methods count is 62833, we cannot cross 65535

Lets decompile to Java as well the original APK

"..\ANXVerseTools\jadx\bin\jadx.bat" -d .\src\ANXCamera12\java -r .\originals\MiuiCamera.apk --show-bad-code

It seems we have decompiled without errors.
This porting is going to have lot of trouble due to presence of obfuscation in the build
**We made a wrong step above which has now been corrected. On Line 25 `.\src\ANXCamera12` --> `.\src\ANXCamera12\src`

We  avoid gui git when we are dealing with lots of files. Here we want to commit 28040 files

Lets try to recompile it once (We will use the rebuild.bat script we made during last port) go to Line 75

java  -jar "..\ANXVerseTools\apktool-cli-all.jar" b -p ..\ANXVerseTools\MiuiFrameworks -o .\out\ANXCamera-Unsigned.apk .\src\ANXCamera12\src

it finished compiling with no errors

Lets sign and zipalign
..\ANXVerseTools\apksigner.bat sign --key ..\ANXVerseTools\testkey.pk8 --cert ..\ANXVerseTools\testkey.x509.pem  --in .\out\ANXCamera-Unsigned.apk --out .\out\ANXCamera-Unaligned.apk
..\ANXVerseTools\zipalign.exe -f 4  .\out\ANXCamera-Unaligned.apk .\out\ANXCamera.apk

Lets try install the recompiled APK, its supposed to fail
adb install -g .\out\ANXCamera.apk
Performing Streamed Install
adb: failed to install .\out\ANXCamera.apk: Failure [INSTALL_PARSE_FAILED_NO_CERTIFICATES: Failed collecting certificates for /data/app/vmdl1336887076.tmp/base.apk: Failed to collect certificates from /data/app/vmdl1336887076.tmp/base.apk: META-INF/TESTKEY.SF indicates /data/app/vmdl1336887076.tmp/base.apk is signed using APK Signature Scheme v2, but no such signature was found. Signature stripped?]
hmm. I have no idea what that means

Lets come back to previous issue of INSTALL_PARSE_FAILED_NO_CERTIFICATES
We made 2 mistakes
we did apksign first and then did a zipalign

    If you use apksigner, zipalign must only be performed before the APK file has been signed. If you sign your APK using apksigner and make further changes to the APK, its signature is invalidated.
    If you use jarsigner, zipalign must only be performed after the APK file has been signed.

My old script used to use jarsigner. I followed the same order here which is wrong.

lets correct the script above

First rename the output of APKTool
java  -jar "..\ANXVerseTools\apktool-cli-all.jar" b -p ..\ANXVerseTools\MiuiFrameworks -o .\out\ANXCamera-Unaligned.apk .\src\ANXCamera12\src

Lets zipalign then apksign
..\ANXVerseTools\zipalign.exe -p -f 4  .\out\ANXCamera-Unaligned.apk .\out\ANXCamera-Unsigned.apk
..\ANXVerseTools\apksigner.bat sign -v --key ..\ANXVerseTools\testkey.pk8 --cert ..\ANXVerseTools\testkey.x509.pem  --in .\out\ANXCamera-Unsigned.apk --out .\out\ANXCamera.apk

So when we rebuilt, we had an error during recompilation, apparently 1 style entry got duplicated. We comment out the duplicated entry

Lets try installing it again
adb install -g .\out\ANXCamera.apk

Booom! Failure! 000
PS C:\Projects\ANXVerse> adb install -g .\out\ANXCamera.apk
Performing Streamed Install
adb: failed to install .\out\ANXCamera.apk: Failure [INSTALL_FAILED_MISSING_SHARED_LIBRARY: Reconciliation failed...: Reconcile failed: Package com.android.camera requires unavailable shared library cloud-common.jar; failing!]

For the time being we will make this not required.
Lets rebuild and install
PS C:\Projects\ANXVerse> adb install -g .\out\ANXCamera.apk
Performing Streamed Install
Success

Booom! Success! 0.1

It installed. But doesnt run. Thats weird it needs Miui, Star Port didn't need miui.
